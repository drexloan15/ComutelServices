{
  "info": {
    "name": "ComutelServices Auth + RBAC",
    "_postman_id": "9ec07147-ef72-4f63-b129-d1803f7d7eea",
    "description": "Flujo completo: bootstrap-admin, login admin, cambio de rol y validaciones 403/200.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "01 Bootstrap Admin (Opcional, una sola vez)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\",\n  \"fullName\": \"Comutel Admin\",\n  \"bootstrapSecret\": \"{{bootstrapSecret}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/bootstrap-admin",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "auth",
            "bootstrap-admin"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Bootstrap admin responde 201 o 409', function () {",
              "  pm.expect([201, 409]).to.include(pm.response.code);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "02 Login Admin",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "auth",
            "login"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Login admin OK', function () {",
              "  pm.response.to.have.status(201);",
              "});",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('adminAccessToken', json.accessToken);",
              "pm.collectionVariables.set('adminRefreshToken', json.refreshToken);"
            ]
          }
        }
      ]
    },
    {
      "name": "03 Listar Users (ADMIN) + Capturar IDs",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{adminAccessToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/users",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('ADMIN puede listar users', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "const users = pm.response.json();",
              "const requester = users.find(u => u.email === pm.collectionVariables.get('requesterEmail'));",
              "const agent = users.find(u => u.email === pm.collectionVariables.get('agentEmail'));",
              "if (requester) pm.collectionVariables.set('requesterUserId', requester.id);",
              "if (agent) pm.collectionVariables.set('agentUserId', agent.id);"
            ]
          }
        }
      ]
    },
    {
      "name": "04 Login Requester",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{requesterEmail}}\",\n  \"password\": \"{{requesterPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "auth",
            "login"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Login requester OK', function () {",
              "  pm.response.to.have.status(201);",
              "});",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('requesterAccessToken', json.accessToken);",
              "pm.collectionVariables.set('requesterRefreshToken', json.refreshToken);"
            ]
          }
        }
      ]
    },
    {
      "name": "05 Requester intenta listar users (403)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{requesterAccessToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/users",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('REQUESTER NO puede listar users', function () {",
              "  pm.response.to.have.status(403);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "06 Requester crea Ticket (201)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{requesterAccessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"title\": \"Incidente RBAC prueba\",\n  \"requesterName\": \"Comutel Requester\",\n  \"requesterEmail\": \"{{requesterEmail}}\",\n  \"priority\": \"MEDIUM\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/tickets",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "tickets"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Requester crea ticket', function () {",
              "  pm.response.to.have.status(201);",
              "});",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('ticketId', json.id);"
            ]
          }
        }
      ]
    },
    {
      "name": "07 Requester intenta PATCH ticket (403)",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{requesterAccessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"status\": \"IN_PROGRESS\",\n  \"statusReason\": \"Requester no debe poder editar estado\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/tickets/{{ticketId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "tickets",
            "{{ticketId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('REQUESTER NO puede editar ticket', function () {",
              "  pm.response.to.have.status(403);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "08 ADMIN cambia rol REQUESTER -> AGENT (200)",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{adminAccessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"role\": \"AGENT\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/users/{{requesterUserId}}/role",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{requesterUserId}}",
            "role"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('ADMIN cambia rol correctamente', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "const json = pm.response.json();",
              "pm.expect(json.role).to.eql('AGENT');"
            ]
          }
        }
      ]
    },
    {
      "name": "09 Login usuario promovido (ex-requester)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{requesterEmail}}\",\n  \"password\": \"{{requesterPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "auth",
            "login"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Login promovido OK', function () {",
              "  pm.response.to.have.status(201);",
              "});",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('promotedAccessToken', json.accessToken);"
            ]
          }
        }
      ]
    },
    {
      "name": "10 Usuario promovido PATCH ticket (200)",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{promotedAccessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"status\": \"IN_PROGRESS\",\n  \"statusReason\": \"Ahora el usuario es AGENT\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/tickets/{{ticketId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "tickets",
            "{{ticketId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('AGENT puede editar ticket', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "const json = pm.response.json();",
              "pm.expect(json.status).to.eql('IN_PROGRESS');"
            ]
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3001/api"
    },
    {
      "key": "bootstrapSecret",
      "value": "dev_bootstrap_admin_secret"
    },
    {
      "key": "adminEmail",
      "value": "admin@comutel.local"
    },
    {
      "key": "adminPassword",
      "value": "Password123!"
    },
    {
      "key": "agentEmail",
      "value": "agent@comutel.local"
    },
    {
      "key": "agentPassword",
      "value": "Password123!"
    },
    {
      "key": "requesterEmail",
      "value": "requester@comutel.local"
    },
    {
      "key": "requesterPassword",
      "value": "Password123!"
    },
    {
      "key": "adminAccessToken",
      "value": ""
    },
    {
      "key": "adminRefreshToken",
      "value": ""
    },
    {
      "key": "requesterAccessToken",
      "value": ""
    },
    {
      "key": "requesterRefreshToken",
      "value": ""
    },
    {
      "key": "promotedAccessToken",
      "value": ""
    },
    {
      "key": "requesterUserId",
      "value": ""
    },
    {
      "key": "agentUserId",
      "value": ""
    },
    {
      "key": "ticketId",
      "value": ""
    }
  ]
}
